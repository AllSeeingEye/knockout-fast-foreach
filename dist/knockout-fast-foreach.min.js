!function(e,t){"function"==typeof define&&define.amd?define(["knockout"],t):"object"==typeof exports?module.exports=t(require("knockout")):e.KnockoutFastForeach=t(e.ko)}(this,function(e){"use strict";function t(e){return!!e&&"object"==typeof e&&e.constructor===Object}function n(e){return 8==e.nodeType&&u.test(o?e.text:e.nodeValue)}function s(t){var n,s=document.createElement("div");return t.content?n=t.content:"SCRIPT"===t.tagName?(n=document.createElement("div"),n.innerHTML=t.text):n=t,e.utils.arrayForEach(e.virtualElements.childNodes(n),function(e){e&&s.insertBefore(e.cloneNode(!0),null)}),s}function i(e,t){return{status:"added",value:e,index:t}}function a(t){this.element=t.element,this.container=n(this.element)?this.element.parentNode:this.element,this.$context=t.$context,this.data=t.data,this.as=t.as,this.noContext=t.noContext,this.templateNode=s(t.name?document.getElementById(t.name).cloneNode(!0):t.element),this.afterQueueFlush=t.afterQueueFlush,this.beforeQueueFlush=t.beforeQueueFlush,this.changeQueue=[],this.lastNodesList=[],this.indexesToDelete=[],this.rendering_queued=!1,e.virtualElements.emptyNode(this.element);var a=e.unwrap(this.data);a.map&&this.onArrayChange(a.map(i)),e.isObservable(this.data)&&(this.data.indexOf||(this.data=this.data.extend({trackArrayChanges:!0})),this.changeSubs=this.data.subscribe(this.onArrayChange,this,"arrayChange"))}var o=document&&"<!--test-->"===document.createComment("test").text,u=o?/^<!--\s*ko(?:\s+([\s\S]+))?\s*-->$/:/^\s*ko(?:\s+([\s\S]+))?\s*$/;a.animateFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)},a.prototype.dispose=function(){this.changeSubs&&this.changeSubs.dispose()},a.prototype.onArrayChange=function(t){var n=this,s={added:[],deleted:[]};e.utils.arrayForEach(t,function(e){s[e.status].push(e)}),s.deleted.length>0&&(this.changeQueue.push.apply(this.changeQueue,s.deleted),this.changeQueue.push({status:"clearDeletedIndexes"})),this.changeQueue.push.apply(this.changeQueue,s.added),this.changeQueue.length>0&&!this.rendering_queued&&(this.rendering_queued=!0,a.animateFrame.call(window,function(){n.processQueue()}))},a.prototype.processQueue=function(){var t=this;"function"==typeof this.beforeQueueFlush&&this.beforeQueueFlush(this.changeQueue),e.utils.arrayForEach(this.changeQueue,function(e){t[e.status](e.index,e.value)}),this.rendering_queued=!1,"function"==typeof this.afterQueueFlush&&this.afterQueueFlush(this.changeQueue),this.changeQueue=[]},a.prototype.added=function(t,n){var s,i=this.lastNodesList[t-1]||null,a=this.templateNode.cloneNode(!0),o=e.virtualElements.childNodes(a);s=this.noContext?this.$context.extend({$item:n}):this.$context.createChildContext(n,this.as||null),this.lastNodesList.splice(t,0,o[o.length-1]),e.applyBindingsToDescendants(s,a);for(var u=o.length-1;u>=0;--u){var r=o[u];if(!r)return;e.virtualElements.insertAfter(this.element,r,i)}},a.prototype.deleted=function(t){var n=this.lastNodesList[t],s=this.lastNodesList[t-1]||this.element;do n=n.previousSibling,e.removeNode(n&&n.nextSibling||e.virtualElements.firstChild(this.element));while(n&&n!==s);this.lastNodesList[t]=this.lastNodesList[t-1],this.indexesToDelete.push(t)},a.prototype.clearDeletedIndexes=function(){for(var e=this.indexesToDelete.length-1;e>=0;--e)this.lastNodesList.splice(this.indexesToDelete[e],1);this.indexesToDelete=[]},e.bindingHandlers.fastForEach={init:function(n,s,i,o,u){var r,h=s();return t(h)?(h.element=h.element||n,h.$context=u,r=new a(h)):r=new a({element:n,data:e.unwrap(u.$rawData)===h?u.$rawData:h,$context:u}),e.utils.domNodeDisposal.addDisposeCallback(n,function(){r.dispose()}),{controlsDescendantBindings:!0}},FastForEach:a},e.virtualElements.allowedBindings.fastForEach=!0});